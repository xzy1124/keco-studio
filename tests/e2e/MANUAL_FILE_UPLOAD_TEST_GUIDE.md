# 文件上传安全性测试 - 半自动测试指南

## 📋 概述

这是一个半自动的文件上传安全性测试。测试会在关键步骤暂停，让你手动操作，然后自动验证结果。

## 🚀 如何运行

```bash
npm run test:upload-security:manual
```

或者：

```bash
npx playwright test tests/e2e/specs/file-upload-security-manual.spec.ts --headed
```

**重要**：必须使用 `--headed` 参数，这样你才能看到浏览器并手动操作。

## 📝 测试步骤

测试会按照以下步骤进行，每一步都会在终端显示提示信息，**测试会在每一步暂停**，让你有时间操作。

**重要**：当测试暂停时，Playwright Inspector 窗口会自动打开（或按 F8 打开）。完成操作后，点击 Inspector 中的 "Resume" 按钮（或按 F8）继续测试。

### 步骤 1: 登录

```
=== STEP 1: Login ===
```

**操作**：
1. 浏览器会自动打开登录页面
2. **测试会暂停** - Playwright Inspector 会打开
3. 在浏览器中输入你的账号密码登录
4. 等待页面跳转（离开登录页面）
5. 在 Playwright Inspector 中点击 **"Resume"** 按钮（或按 **F8**）继续

**完成后**：测试会自动检测登录状态并继续到下一步

---

### 步骤 2: 导航到 Library 页面

```
=== STEP 2: Navigate to Library Page ===
```

**操作**：
1. 点击侧边栏中的一个项目（Project）
2. 点击一个库（Library）（可以在侧边栏的树中，或者在页面上的库卡片）
3. 等待库页面加载完成（应该能看到库的名称作为标题）
4. **重要**：确保这个库的 predefined template 中包含 `image` 或 `file` 类型的字段

**完成后**：在 Playwright Inspector 中点击 **"Resume"** 按钮（或按 **F8**）继续。测试会检查 URL 确认你在库页面上

---

### 步骤 3: 打开 "Add New Asset" 表单

```
=== STEP 3: Open Add New Asset Form ===
```

**操作**：
1. 在表格底部找到并点击 "+ Add New Asset" 按钮
2. 等待新行出现，包含输入字段
3. 确保能看到文件上传的字段（如果模板中有 image/file 字段）

**完成后**：在 Playwright Inspector 中点击 **"Resume"** 按钮（或按 **F8**）继续。测试会检查文件上传输入框是否存在

---

### 步骤 4-8: 文件上传测试

测试会依次测试以下场景，每一步都会提示你操作：

#### 测试 1: 拒绝可执行文件 (.exe)

**操作**：
- 尝试上传一个 `.exe` 文件
- **注意**：由于文件选择对话框的 `accept` 属性限制，`.exe` 文件可能不会在文件选择器中显示
- 如果文件选择器限制了你，可以跳过这个手动测试（自动测试会直接通过代码测试）
- 观察是否出现错误消息

**预期结果**：应该显示错误消息，拒绝上传

---

#### 测试 2: 拒绝 Shell 脚本 (.sh)

**操作**：
- 尝试上传一个 `.sh` 文件
- **注意**：由于文件选择对话框的 `accept` 属性限制，`.sh` 文件可能不会在文件选择器中显示
- 观察是否出现错误消息

**预期结果**：应该显示错误消息，拒绝上传

---

#### 测试 3: 拒绝 PHP 文件 (.php)

**操作**：
- 尝试上传一个 `.php` 文件
- **注意**：由于文件选择对话框的 `accept` 属性限制，`.php` 文件可能不会在文件选择器中显示
- 观察是否出现错误消息

**预期结果**：应该显示错误消息，拒绝上传

---

#### 测试 4: 拒绝 JavaScript 文件 (.js)

**操作**：
- 尝试上传一个 `.js` 文件
- **重要说明**：
  - 文件选择对话框的 `accept` 属性会过滤掉 `.js` 文件，这是正常的安全措施
  - `accept` 属性只是用户体验优化，真正的验证在服务端的 `validateMediaFile` 函数中
  - 如果文件选择器限制了你，可以跳过这个手动测试（自动测试会直接通过代码测试）
  - 观察是否出现错误消息

**预期结果**：应该显示错误消息，拒绝上传

**技术说明**：
- `accept` 属性只是 HTML5 的文件选择过滤，用户可以绕过（比如通过浏览器控制台）
- 真正的安全验证在 `validateMediaFile` 函数中（`mediaFileUploadService.ts`）
- 自动测试使用 `setInputFiles()` 可以绕过 `accept` 限制，直接测试服务端验证

---

#### 测试 5: 接受有效的图片文件 (PNG)

**操作**：
- 尝试上传一个有效的 PNG 图片文件
- 观察是否出现错误

**预期结果**：应该被接受，不显示错误消息

---

#### 测试 6: 文件大小限制（可选）

**操作**：
- （可选）尝试上传一个大于 5MB 的文件

**预期结果**：如果文件超过 5MB，应该显示文件大小错误

---

## ✅ 测试结果

每一步测试完成后，终端会显示：
- ✅ PASS：测试通过（行为符合预期）
- ❌ FAIL：测试失败（行为不符合预期）
- ℹ️ 信息：相关信息

所有测试完成后，会显示总结信息。

## 🔍 故障排除

### 问题：找不到文件上传输入框

**可能原因**：
- 库的 predefined template 中没有 `image` 或 `file` 类型的字段
- 没有正确点击 "+ Add New Asset" 按钮

**解决方案**：
- 确保使用的库有包含 image/file 字段的 template
- 重新点击 "+ Add New Asset" 按钮

### 问题：测试卡住不动

**可能原因**：
- 正在等待你的操作
- 浏览器窗口没有焦点

**解决方案**：
- 查看终端提示信息，按照提示操作
- 确保浏览器窗口可见且可操作

### 问题：错误消息没有出现

**可能原因**：
- 文件类型验证逻辑有问题
- 错误消息的选择器不正确

**解决方案**：
- 手动检查是否有错误消息显示（即使测试没检测到）
- 查看浏览器控制台是否有错误

## 💡 提示

1. **保持浏览器窗口可见**：测试需要你在浏览器中操作
2. **仔细阅读终端提示**：每一步都会告诉你该做什么
3. **可以重复运行**：如果某一步失败了，可以重新运行测试
4. **测试文件位置**：测试会在 `/tmp` 目录创建临时测试文件，测试结束后会自动清理

## 📚 相关文档

- [自动测试文档](./FILE_UPLOAD_SECURITY_TEST_GUIDE.md)
- [Playwright 文档](https://playwright.dev/)

