# å¿˜è®°å¯†ç åŠŸèƒ½ - ä½¿ç”¨ Supabase é»˜è®¤é‚®ä»¶æœåŠ¡çš„å®Œæ•´æµç¨‹

## ğŸ“‹ æµç¨‹æ¦‚è§ˆ

ä½¿ç”¨ Supabase çš„é»˜è®¤é‚®ä»¶æœåŠ¡ï¼Œæ•´ä¸ªæµç¨‹åˆ†ä¸ºä¸¤ä¸ªé¡µé¢ï¼š

1. **ç¬¬ä¸€æ­¥ï¼ˆVerifyï¼‰** - `/forgot-password`
   - ç”¨æˆ·è¾“å…¥é‚®ç®±
   - ç‚¹å‡»"Send reset link"
   - Supabase å‘é€é‡ç½®é“¾æ¥åˆ°é‚®ç®±

2. **ç¬¬äºŒæ­¥ï¼ˆChange passwordï¼‰** - `/auth/reset-password`
   - ç”¨æˆ·ç‚¹å‡»é‚®ä»¶ä¸­çš„é“¾æ¥
   - è‡ªåŠ¨è·³è½¬åˆ°é‡ç½®å¯†ç é¡µé¢
   - ç”¨æˆ·è¾“å…¥æ–°å¯†ç 
   - ç‚¹å‡»"Confirm"
   - è‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µé¢

---

## ğŸ”„ è¯¦ç»†æµç¨‹è¯´æ˜

### ç¬¬ä¸€æ­¥ï¼šå‘é€é‡ç½®é“¾æ¥ (`/forgot-password`)

#### é¡µé¢åŠŸèƒ½
- âœ… è¿”å›æŒ‰é’®ï¼ˆè¿”å›åˆ°é¦–é¡µï¼‰
- âœ… æ ‡é¢˜ "Forgot Your Password"
- âœ… æ­¥éª¤æŒ‡ç¤ºå™¨ï¼ˆæ­¥éª¤ 1 æ¿€æ´»ï¼Œæ­¥éª¤ 2 æœªæ¿€æ´»ï¼‰
- âœ… Email or username è¾“å…¥æ¡†
- âœ… "Send reset link" æŒ‰é’®
- âœ… æˆåŠŸ/é”™è¯¯æ¶ˆæ¯æç¤º

#### ç”¨æˆ·æ“ä½œæµç¨‹
1. ç”¨æˆ·è®¿é—® `/forgot-password` é¡µé¢
2. è¾“å…¥é‚®ç®±åœ°å€ï¼ˆæˆ–ç”¨æˆ·åï¼‰
3. ç‚¹å‡»"Send reset link"æŒ‰é’®
4. ç³»ç»Ÿè°ƒç”¨ `supabase.auth.resetPasswordForEmail()`
5. Supabase è‡ªåŠ¨å‘é€åŒ…å«é‡ç½®ä»¤ç‰Œçš„é‚®ä»¶
6. æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯ï¼š"Password reset email sent! Please check your inbox and click the link to reset your password."

#### æŠ€æœ¯å®ç°
```typescript
const { error } = await supabase.auth.resetPasswordForEmail(email, {
  redirectTo: `${window.location.origin}/auth/reset-password`,
});
```

**é‡è¦ï¼š** `redirectTo` å‚æ•°å‘Šè¯‰ Supabaseï¼Œå½“ç”¨æˆ·ç‚¹å‡»é‚®ä»¶ä¸­çš„é“¾æ¥æ—¶ï¼Œåº”è¯¥è·³è½¬åˆ°å“ªä¸ªé¡µé¢ã€‚

---

### ç¬¬äºŒæ­¥ï¼šé‡ç½®å¯†ç  (`/auth/reset-password`)

#### é¡µé¢åŠŸèƒ½
- âœ… è¿”å›æŒ‰é’®ï¼ˆè¿”å›åˆ° `/forgot-password`ï¼‰
- âœ… æ ‡é¢˜ "Forgot Your Password"
- âœ… æ­¥éª¤æŒ‡ç¤ºå™¨ï¼ˆæ­¥éª¤ 1 æœªæ¿€æ´»ï¼Œæ­¥éª¤ 2 æ¿€æ´»ï¼‰
- âœ… New password è¾“å…¥æ¡†
- âœ… Confirm password è¾“å…¥æ¡†
- âœ… "Confirm" æŒ‰é’®
- âœ… æˆåŠŸ/é”™è¯¯æ¶ˆæ¯æç¤º
- âœ… è‡ªåŠ¨éªŒè¯é‡ç½®ä»¤ç‰Œ

#### ç”¨æˆ·æ“ä½œæµç¨‹
1. **ç”¨æˆ·ç‚¹å‡»é‚®ä»¶ä¸­çš„é‡ç½®é“¾æ¥**
   - Supabase å‘é€çš„é‚®ä»¶åŒ…å«ä¸€ä¸ªé‡ç½®é“¾æ¥
   - é“¾æ¥æ ¼å¼ï¼š`https://yourdomain.com/auth/reset-password#access_token=xxx&type=recovery`

2. **è‡ªåŠ¨è·³è½¬åˆ°é‡ç½®å¯†ç é¡µé¢**
   - æµè§ˆå™¨è‡ªåŠ¨è·³è½¬åˆ° `/auth/reset-password`
   - URL ä¸­åŒ…å« hash å‚æ•°ï¼š`#access_token=xxx&type=recovery`

3. **è‡ªåŠ¨éªŒè¯ä»¤ç‰Œ**
   - Supabase å®¢æˆ·ç«¯è‡ªåŠ¨å¤„ç† hash ä¸­çš„ `access_token`
   - è‡ªåŠ¨åˆ›å»º sessionï¼ˆæ— éœ€æ‰‹åŠ¨éªŒè¯ï¼‰

4. **ç”¨æˆ·è¾“å…¥æ–°å¯†ç **
   - è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘ 6 ä¸ªå­—ç¬¦ï¼‰
   - è¾“å…¥ç¡®è®¤å¯†ç ï¼ˆå¿…é¡»ä¸æ–°å¯†ç ä¸€è‡´ï¼‰

5. **ç‚¹å‡»"Confirm"æŒ‰é’®**
   - éªŒè¯å¯†ç åŒ¹é…å’Œé•¿åº¦
   - è°ƒç”¨ `supabase.auth.updateUser({ password })` æ›´æ–°å¯†ç 

6. **æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯**
   - æ˜¾ç¤ºï¼š"Password reset successfully! Redirecting to login..."

7. **è‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µé¢**
   - 1.5 ç§’åè‡ªåŠ¨è·³è½¬åˆ°ï¼š`/?message=Password reset successfully`
   - ç”¨æˆ·å¯ä»¥ä½¿ç”¨æ–°å¯†ç ç™»å½•

#### æŠ€æœ¯å®ç°

**éªŒè¯ä»¤ç‰Œï¼ˆè‡ªåŠ¨å¤„ç†ï¼‰ï¼š**
```typescript
// Supabase è‡ªåŠ¨å¤„ç† URL hash ä¸­çš„ access_token
// æˆ‘ä»¬åªéœ€è¦æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„ session
const { data: { session } } = await supabase.auth.getSession();
```

**æ›´æ–°å¯†ç ï¼š**
```typescript
const { error } = await supabase.auth.updateUser({
  password: newPassword,
});
```

**è·³è½¬åˆ°ç™»å½•é¡µé¢ï¼š**
```typescript
router.push('/?message=Password reset successfully');
```

---

## âš™ï¸ Supabase Dashboard é…ç½®

### 1. é…ç½®é‡å®šå‘ URLï¼ˆå¿…é¡»ï¼ï¼‰

1. ç™»å½• [Supabase Dashboard](https://app.supabase.com)
2. é€‰æ‹©ä½ çš„é¡¹ç›®
3. è¿›å…¥ **Authentication** > **URL Configuration**
4. åœ¨ **Redirect URLs** ä¸­æ·»åŠ ï¼š
   ```
   http://localhost:3000/auth/reset-password
   https://yourdomain.com/auth/reset-password
   ```
   âš ï¸ **å¦‚æœä¸é…ç½®ï¼Œé‡ç½®é“¾æ¥æ— æ³•æ­£ç¡®è·³è½¬ï¼**

5. åœ¨ **Site URL** ä¸­è®¾ç½®ï¼š
   - å¼€å‘ç¯å¢ƒï¼š`http://localhost:3000`
   - ç”Ÿäº§ç¯å¢ƒï¼š`https://yourdomain.com`

### 2. é…ç½®é‚®ä»¶æ¨¡æ¿ï¼ˆå¯é€‰ï¼‰

1. è¿›å…¥ **Authentication** > **Email Templates**
2. æ‰¾åˆ° **Reset Password** æ¨¡æ¿
3. å¯ä»¥è‡ªå®šä¹‰é‚®ä»¶ä¸»é¢˜å’Œå†…å®¹
4. å¿…é¡»åŒ…å« `{{ .ConfirmationURL }}` ä½œä¸ºé‡ç½®é“¾æ¥

---

## ğŸ” å®Œæ•´æµç¨‹ç¤ºä¾‹

### åœºæ™¯ï¼šç”¨æˆ·å¿˜è®°å¯†ç 

1. **ç”¨æˆ·è®¿é—®å¿˜è®°å¯†ç é¡µé¢**
   ```
   ç”¨æˆ· â†’ è®¿é—® /forgot-password
   ```

2. **ç”¨æˆ·è¾“å…¥é‚®ç®±å¹¶å‘é€**
   ```
   ç”¨æˆ·è¾“å…¥ï¼šuser@example.com
   ç‚¹å‡»ï¼š"Send reset link"
   ç³»ç»Ÿè°ƒç”¨ï¼šsupabase.auth.resetPasswordForEmail()
   ```

3. **Supabase å‘é€é‚®ä»¶**
   ```
   Supabase â†’ å‘é€é‚®ä»¶åˆ° user@example.com
   é‚®ä»¶åŒ…å«ï¼šé‡ç½®é“¾æ¥
   é“¾æ¥æŒ‡å‘ï¼šhttps://yourdomain.com/auth/reset-password#access_token=xxx&type=recovery
   ```

4. **ç”¨æˆ·ç‚¹å‡»é‚®ä»¶ä¸­çš„é“¾æ¥**
   ```
   ç”¨æˆ· â†’ ç‚¹å‡»é‚®ä»¶ä¸­çš„é“¾æ¥
   æµè§ˆå™¨ â†’ è‡ªåŠ¨è·³è½¬åˆ° /auth/reset-password#access_token=xxx&type=recovery
   ```

5. **é¡µé¢è‡ªåŠ¨éªŒè¯ä»¤ç‰Œ**
   ```
   Supabase å®¢æˆ·ç«¯ â†’ è‡ªåŠ¨å¤„ç† hash ä¸­çš„ access_token
   è‡ªåŠ¨åˆ›å»º â†’ session
   é¡µé¢æ˜¾ç¤º â†’ é‡ç½®å¯†ç è¡¨å•
   ```

6. **ç”¨æˆ·è¾“å…¥æ–°å¯†ç **
   ```
   ç”¨æˆ·è¾“å…¥ï¼šnewPassword123
   ç¡®è®¤å¯†ç ï¼šnewPassword123
   ç‚¹å‡»ï¼š"Confirm"
   ```

7. **ç³»ç»Ÿæ›´æ–°å¯†ç **
   ```
   ç³»ç»Ÿè°ƒç”¨ï¼šsupabase.auth.updateUser({ password: 'newPassword123' })
   å¯†ç æ›´æ–°æˆåŠŸ
   ```

8. **è·³è½¬åˆ°ç™»å½•é¡µé¢**
   ```
   æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
   1.5 ç§’å â†’ è·³è½¬åˆ° /?message=Password reset successfully
   ç”¨æˆ·å¯ä»¥ä½¿ç”¨æ–°å¯†ç ç™»å½•
   ```

---

## ğŸ¯ å…³é”®ç‚¹æ€»ç»“

### âœ… ç¬¬ä¸€æ­¥ï¼ˆVerifyï¼‰çš„å˜åŒ–
- âŒ **ç§»é™¤äº† Code è¾“å…¥æ¡†**ï¼ˆSupabase ä¸å‘é€éªŒè¯ç ï¼‰
- âœ… **åªä¿ç•™ Email è¾“å…¥æ¡†**
- âœ… **æŒ‰é’®æ”¹ä¸º "Send reset link"**
- âœ… **ç§»é™¤äº† "Resend code" é“¾æ¥**ï¼ˆå¯ä»¥æ·»åŠ "Resend email"åŠŸèƒ½ï¼‰

### âœ… ç¬¬äºŒæ­¥ï¼ˆChange passwordï¼‰çš„ä½ç½®
- âœ… **ç‹¬ç«‹é¡µé¢**ï¼š`/auth/reset-password`
- âœ… **é€šè¿‡é‚®ä»¶é“¾æ¥è®¿é—®**ï¼ˆä¸æ˜¯ä»ç¬¬ä¸€æ­¥åˆ‡æ¢ï¼‰
- âœ… **è‡ªåŠ¨éªŒè¯ä»¤ç‰Œ**ï¼ˆSupabase è‡ªåŠ¨å¤„ç†ï¼‰

### âœ… è·³è½¬æµç¨‹
1. `/forgot-password` â†’ å‘é€é‡ç½®é“¾æ¥
2. é‚®ä»¶ä¸­çš„é“¾æ¥ â†’ `/auth/reset-password`ï¼ˆè‡ªåŠ¨éªŒè¯ï¼‰
3. `/auth/reset-password` â†’ `/`ï¼ˆç™»å½•é¡µé¢ï¼Œå¯†ç é‡ç½®æˆåŠŸåï¼‰

---

## ğŸ§ª æµ‹è¯•æ¸…å•

### æµ‹è¯•æ­¥éª¤ 1ï¼šå‘é€é‡ç½®é“¾æ¥
- [ ] è®¿é—® `/forgot-password` é¡µé¢
- [ ] è¾“å…¥å·²æ³¨å†Œçš„é‚®ç®±
- [ ] ç‚¹å‡»"Send reset link"
- [ ] çœ‹åˆ°æˆåŠŸæ¶ˆæ¯
- [ ] æ£€æŸ¥é‚®ç®±æ”¶åˆ°é‡ç½®é‚®ä»¶

### æµ‹è¯•æ­¥éª¤ 2ï¼šé‡ç½®å¯†ç 
- [ ] ç‚¹å‡»é‚®ä»¶ä¸­çš„é‡ç½®é“¾æ¥
- [ ] è‡ªåŠ¨è·³è½¬åˆ° `/auth/reset-password`
- [ ] çœ‹åˆ°æ­¥éª¤ 2 ä¸ºæ¿€æ´»çŠ¶æ€
- [ ] è¾“å…¥æ–°å¯†ç å’Œç¡®è®¤å¯†ç 
- [ ] ç‚¹å‡»"Confirm"
- [ ] çœ‹åˆ°æˆåŠŸæ¶ˆæ¯
- [ ] è‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µé¢
- [ ] ä½¿ç”¨æ–°å¯†ç å¯ä»¥ç™»å½•

### æµ‹è¯•é”™è¯¯æƒ…å†µ
- [ ] æ— æ•ˆçš„é‡ç½®é“¾æ¥ â†’ æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
- [ ] å¯†ç ä¸åŒ¹é… â†’ æ˜¾ç¤ºé”™è¯¯
- [ ] å¯†ç å¤ªçŸ­ â†’ æ˜¾ç¤ºé”™è¯¯

---

## ğŸ“ ä»£ç æ–‡ä»¶

- `/app/forgot-password/page.tsx` - ç¬¬ä¸€æ­¥ï¼šå‘é€é‡ç½®é“¾æ¥
- `/app/forgot-password/page.module.css` - ç¬¬ä¸€æ­¥æ ·å¼
- `/app/auth/reset-password/page.tsx` - ç¬¬äºŒæ­¥ï¼šé‡ç½®å¯†ç 
- `/app/auth/reset-password/page.module.css` - ç¬¬äºŒæ­¥æ ·å¼

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å¿…é¡»é…ç½®é‡å®šå‘ URL**ï¼šåœ¨ Supabase Dashboard ä¸­é…ç½® `/auth/reset-password`
2. **ä»¤ç‰Œè‡ªåŠ¨å¤„ç†**ï¼šSupabase å®¢æˆ·ç«¯ä¼šè‡ªåŠ¨å¤„ç† URL hash ä¸­çš„ä»¤ç‰Œ
3. **Session éªŒè¯**ï¼šé‡ç½®å¯†ç é¡µé¢ä¼šè‡ªåŠ¨æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„ session
4. **å¯†ç éªŒè¯**ï¼šç¡®ä¿å¯†ç è‡³å°‘ 6 ä¸ªå­—ç¬¦ï¼Œä¸”ä¸¤æ¬¡è¾“å…¥ä¸€è‡´
5. **é”™è¯¯å¤„ç†**ï¼šæä¾›æ¸…æ™°çš„é”™è¯¯æ¶ˆæ¯å’Œé‡è¯•é€‰é¡¹

---

## ğŸš€ ä¸‹ä¸€æ­¥

1. âœ… é™æ€é¡µé¢å·²å®Œæˆ
2. âœ… äº¤äº’é€»è¾‘å·²å®ç°
3. â³ é…ç½® Supabase Dashboardï¼ˆé‡å®šå‘ URLï¼‰
4. â³ æµ‹è¯•å®Œæ•´æµç¨‹
5. â³ è‡ªå®šä¹‰é‚®ä»¶æ¨¡æ¿ï¼ˆå¯é€‰ï¼‰

