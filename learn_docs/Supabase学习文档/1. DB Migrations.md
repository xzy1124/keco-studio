ä¸‹é¢æˆ‘ä¼šç”¨**é€šä¿—æ˜“æ‡‚ä½†ä¸“ä¸šçš„æ–¹å¼**ï¼Œç³»ç»Ÿæ€§è®²æ¸…æ¥šï¼š

### âœ… 1. ä¸ºä»€ä¹ˆå®é™…å¼€å‘ä¸€å®šè¦ä½¿ç”¨ DB Migrationsï¼Ÿ

åœ¨å®é™…å…¬å¸é¡¹ç›®ä¸­ï¼Œ**ä¸ä½¿ç”¨ migrations æ˜¯å‡ ä¹ä¸å¯æ¥å—çš„**ã€‚åŸå› ï¼š

---

#### ğŸ¯ **1ï¼‰å¤šäººåä½œä¸èƒ½åªé â€œæ‰‹åŠ¨æ”¹æ•°æ®åº“â€**

æ²¡æœ‰ migrations æ—¶ï¼š

* æ¯ä¸ªå¼€å‘åœ¨æœ¬åœ°è‡ªå·±æ‰‹åŠ¨æ”¹ schema
* ä¸åŒç¯å¢ƒï¼ˆdev / test / prodï¼‰schema ä¸ä¸€è‡´
* æ–°äººæ‹‰é¡¹ç›®è·‘ä¸èµ·æ¥ï¼Œå› ä¸º DB æ²¡åˆå§‹åŒ–
* çº¿ä¸Šç¯å¢ƒå¯èƒ½å¿˜è®°åŠ å­—æ®µï¼Œå¯¼è‡´ä¸¥é‡ Bug

**æ²¡æœ‰ç»Ÿä¸€ schema ç‰ˆæœ¬ç®¡ç† = æ··ä¹±ã€ä¸å¯æ§ã€å®¹æ˜“å‡ºå¤§äº‹æ•…ã€‚**

---

#### ğŸ¯ **2ï¼‰æ•°æ®åº“å˜åŒ–éœ€è¦â€œç‰ˆæœ¬æ§åˆ¶â€**

å°±åƒä»£ç éœ€è¦ Git ç®¡ç†ç‰ˆæœ¬ä¸€æ ·ï¼š

* æ•°æ®åº“ç»“æ„ä¹Ÿéœ€è¦ç‰ˆæœ¬å·
* éœ€è¦çŸ¥é“ â€œæˆ‘ä»¬æ•°æ®åº“ç»å†äº†å“ªäº›ä¿®æ”¹ï¼Ÿâ€
* å‡ºé”™æ—¶èƒ½å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬

**migrations å°±æ˜¯æ•°æ®åº“çš„ Gitã€‚**

---

#### ğŸ¯ **3ï¼‰éƒ¨ç½²ä¸Šçº¿å¿…é¡»ç¨³å®šå¯é‡å¤**

éƒ¨ç½²æ—¶ä¸èƒ½é  DBA æ‰‹åŠ¨æ•² SQLã€‚

éœ€è¦ï¼š

* è‡ªåŠ¨æ‰§è¡Œ migration
* æ¯å°æœåŠ¡å™¨æ¯æ¬¡éƒ¨ç½²éƒ½èƒ½è‡ªåŠ¨å‡çº§ schema åˆ°åŒä¸€ç‰ˆæœ¬
* æ²¡æœ‰äººå·¥å‚ä¸ â†’ ç¨³å®šã€é«˜å¯é 

**è¿™å°±æ˜¯ migrations çš„æ ¸å¿ƒä»·å€¼ï¼šå¯é‡å¤ + å¯å®¡è®¡ + å¯è¿½æº¯ã€‚**

---

### âœ… 2. ä»€ä¹ˆæ˜¯ Migrationsï¼Ÿ

**Migration = ä¸€ä¸ªå¯æ‰§è¡Œçš„æ•°æ®åº“å˜æ›´æ–‡ä»¶ã€‚**

ä¾‹å¦‚ï¼š

```
20250101_add_users_table.sql
20250102_add_role_column.sql
20250103_remove_old_index.sql
```

æ¯ä¸ª migration æ–‡ä»¶åŒ…å«æ“ä½œæ•°æ®åº“çš„ SQLï¼Œä¾‹å¦‚ï¼š

```sql
ALTER TABLE profiles ADD COLUMN phone text;
```

ç‰¹ç‚¹ï¼š

* æ–‡ä»¶ä¸€æ—¦æ‰§è¡Œï¼Œå°±æ˜¯ä¸€ä¸ªå†å²è®°å½•
* ä¸å…è®¸ä¿®æ”¹å·²æ‰§è¡Œçš„è¿ç§»ï¼ˆå°±åƒä¸èƒ½æ”¹ Git æäº¤ï¼‰
* æ‰€æœ‰ç¯å¢ƒæŒ‰ç…§æ—¶é—´é¡ºåºæ‰§è¡Œï¼Œä¿æŒä¸€è‡´

---

### âœ… 3. ä»€ä¹ˆæ˜¯ â€œschema migrationâ€ï¼Ÿ

æŒ‡ **å¯¹æ•°æ®åº“ç»“æ„ï¼ˆschemaï¼‰è¿›è¡Œä¿®æ”¹çš„ migration**ã€‚

åŒ…æ‹¬ï¼š

#### âœ”ï¸ æ·»åŠ è¡¨ã€ä¿®æ”¹è¡¨å­—æ®µ

```sql
CREATE TABLE profiles (...);
ALTER TABLE profiles ADD COLUMN nickname text;
```

#### âœ”ï¸ æ·»åŠ ç´¢å¼•

```sql
CREATE INDEX idx_profiles_username ON profiles(username);
```

#### âœ”ï¸ æ·»åŠ  enum ç±»å‹ã€è§†å›¾ã€è§¦å‘å™¨ç­‰

```sql
CREATE TYPE mood AS ENUM ('sad', 'ok', 'happy');
```

#### âŒ ä¸åŒ…å«æ•°æ®æ›´æ”¹ï¼ˆé€šå¸¸ï¼‰

æ•°æ®å˜æ›´å±äº **data migration**ï¼Œè€Œä¸æ˜¯ schema migrationã€‚

---

### âœ… 4. ä»€ä¹ˆæ˜¯ â€œschema initâ€ï¼Ÿ

è¿™æ˜¯ migrations çš„ä¸€ä¸ªç‰¹æ®Šé˜¶æ®µï¼Œç”¨äºï¼š

> **åˆå§‹åŒ–æ•´ä¸ªæ•°æ®åº“ç»“æ„ï¼ˆç¬¬ä¸€æ¬¡åˆ›å»º schemaï¼‰**

é€‚ç”¨äºï¼š

* æ–°é¡¹ç›®ç¬¬ä¸€æ¬¡å»ºåº“
* æ–°äººç¬¬ä¸€æ¬¡æ‹‰é¡¹ç›® â†’ è¿è¡Œ schema init â†’ å¾—åˆ°å®Œæ•´ DB

Supabase é‡Œè¡¨ç°ä¸ºï¼š

```
00001_initial_schema.sql
```

å†…å®¹é€šå¸¸åŒ…å«ï¼š

* æ‰€æœ‰è¡¨
* æ‰€æœ‰ç´¢å¼•
* æ‰€æœ‰è§†å›¾
* æ‰€æœ‰è§¦å‘å™¨
* æ‰€æœ‰ RLS ç­–ç•¥
* æ‰€æœ‰åˆå§‹å‡½æ•°

**ç›¸å½“äºæ•°æ®åº“çš„ base snapshotã€‚**

ä¹‹åçš„ä¿®æ”¹æ‰æ˜¯æŒ‰ç‰ˆæœ¬å‘å¸ƒçš„ migration æ–‡ä»¶ã€‚

---

### âœ… 5. Supabase ä¸­çš„ migrations å¦‚ä½•å·¥ä½œï¼Ÿ

Supabase CLI ä¼šï¼š

1. åœ¨æœ¬åœ°ç”Ÿæˆ SQL è¿ç§»æ–‡ä»¶
2. åŒæ­¥åˆ° Git
3. éƒ¨ç½²åˆ°è¿œç¨‹é¡¹ç›®æ—¶è‡ªåŠ¨æ‰§è¡Œ

æ ¸å¿ƒç›®å½•ï¼š

```
supabase/
  migrations/
    20250101_init.sql
    20250115_add_profiles_index.sql
    20250120_add_posts_table.sql
```

**æ‰€æœ‰å¼€å‘åªéœ€è¦æ‹‰ä»£ç  â†’ run migration â†’ å¾—åˆ°å®Œæ•´ä¸€è‡´çš„æ•°æ®åº“ã€‚**

---

### ğŸ”¥ ä¸ºä»€ä¹ˆä½ åœ¨å…¬å¸å¿…é¡»ç”¨ migrationsï¼Ÿ

å¦‚æœä½ ä¸ç”¨ migrationsï¼š

| é—®é¢˜                               | åæœ                    |
| ---------------------------------- | ----------------------- |
| ä½ ä¿®æ”¹äº†æœ¬åœ°æ•°æ®åº“ï¼Œä½†æ²¡æœ‰è®°å½•ä¸‹æ¥ | å…¶ä»–åŒäº‹è·‘ä¸èµ·é¡¹ç›®      |
| ç”Ÿäº§ç¯å¢ƒæ²¡æœ‰åŒæ­¥ä¿®æ”¹               | ä¸Šçº¿ç›´æ¥å´©              |
| æ— æ³•å›æ»š                           | ä¸€æ¬¡è¯¯æ“ä½œ â†’ å…¨å…¬å¸å®•æœº |
| DB å˜æ›´æ— æ³•æäº¤å®¡æ ¸                | å®‰å…¨å®¡æ ¸ä¸é€šè¿‡          |
| å›¢é˜Ÿå¼€å‘å†²çªä¸¥é‡                   | æ•°æ®åº“ç»“æ„ä¸ä¸€è‡´        |

å¾ˆå¤šå…¬å¸ç”šè‡³ä¸¥æ ¼è§„å®šï¼š

> â— ç¦æ­¢æ‰‹åŠ¨æ”¹æ•°æ®åº“
> â— æ‰€æœ‰ schema å˜æ›´å¿…é¡»é€šè¿‡ migration

å› ä¸º database schema æ˜¯æœ€å…³é”®çš„æ•°æ®èµ„äº§ã€‚

---

### ğŸ“Œ æœ€ç»ˆæ€»ç»“ï¼ˆä¸€å¥è¯ç‰ˆï¼‰

* **Migration = æ•°æ®åº“çš„ Git æäº¤**
* **Schema migration = ä¿®æ”¹è¡¨ç»“æ„çš„è¿ç§»**
* **Schema init = åˆå§‹åŒ–æ•´ä¸ªæ•°æ®åº“çš„åŸºç¡€ç‰ˆæœ¬**
* **å®é™…å¼€å‘å¿…é¡»ç”¨ migrationsï¼Œå› ä¸ºå›¢é˜Ÿåä½œã€éƒ¨ç½²ä¸€è‡´æ€§ã€è‡ªåŠ¨åŒ–æµç¨‹éƒ½éœ€è¦å®ƒ**

---



### å®˜æ–¹æ–‡æ¡£ï¼š[Database Migrations | Supabase Docs](https://supabase.com/docs/guides/deployment/database-migrations)

[Declarative database schemas | Supabase Docs](https://supabase.com/docs/guides/local-development/declarative-database-schemas)



```
supabase migration new <name>
```

**åˆ›å»ºä¸€ä¸ªæ–°çš„ migration æ–‡ä»¶**ï¼Œå‘½åä¸º `<timestamp>_<name>.sql`ï¼Œä½ éšååœ¨è¿™ä¸ªæ–‡ä»¶é‡Œå†™å…·ä½“çš„ SQLï¼ˆåˆ›å»ºè¡¨ï¼ä¿®æ”¹è¡¨ç»“æ„ï¼è§¦å‘å™¨ï¼ç´¢å¼•â€¦â€¦ï¼‰ ã€‚



```
supabase migration up
```

å°† æœ¬åœ°æ‰€æœ‰å°šæœªåº”ç”¨çš„ migration ä¾æ¬¡æ‰§è¡Œåˆ°æœ¬åœ°æ•°æ®åº“ï¼ˆé€‚åˆæœ¬åœ°å¼€å‘ç¯å¢ƒï¼‰ ã€‚



```
supabase db reset
```

**é‡ç½®æœ¬åœ°æ•°æ®åº“** â€”â€” åˆ é™¤å½“å‰æ•°æ®åº“ (local Postgres å®¹å™¨)ï¼Œç„¶åæ ¹æ® `supabase/migrations/` ç›®å½•ä¸‹æ‰€æœ‰ migration æ–‡ä»¶ï¼Œ**ä»å¤´** å»ºè¡¨ï¼Œé‡å»º schemaï¼›å¦‚æœä½ æœ‰ `supabase/seed.sql`ï¼Œè¿˜ä¼šè‡ªåŠ¨æ’å…¥åˆå§‹æ•°æ®ã€‚é€‚åˆå¼€å‘æ—¶ â€œæ¸…åº“ + é‡å»º + æ’å…¥åˆå§‹æ•°æ®â€ åœºæ™¯ã€‚ **ç”Ÿäº§ç¯å¢ƒæ…ç”¨ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼**



```
supabase db push
```

**å°†æœ¬åœ°æ‰€æœ‰ migration æ¨é€åˆ°è¿œç¨‹æ•°æ®åº“ï¼ˆçº¿ä¸Š Supabase é¡¹ç›®ï¼‰**ã€‚è¿™ä¼šå°†ä½ æœ¬åœ°å†™å¥½çš„ã€æ–°å¢çš„ migration åº”ç”¨åˆ°è¿œç¨‹æ•°æ®åº“ã€‚ç¬¬ä¸€æ¬¡è¿è¡Œæ—¶ä¼šåœ¨è¿œç¨‹åˆ›å»º migration å†å²è¡¨ï¼Œç„¶åä¹‹ååªæ‰§è¡Œâ€œæœªæ‰§è¡Œè¿‡â€çš„ migrationã€‚é€‚åˆæŠŠå¼€å‘ç¯å¢ƒçš„ schema å˜æ›´éƒ¨ç½²åˆ° production/stagingã€‚



```
supabase db diff -f <name>
```

å¦‚æœä½ åœ¨ Dashboardï¼ˆæˆ–å…¶ä»–å·¥å…·ï¼‰æ‰‹åŠ¨ä¿®æ”¹äº† schemaï¼Œæƒ³æŠŠè¿™äº›ä¿®æ”¹â€œåæ˜ ä¸º migration æ–‡ä»¶â€ â€”â€” ç”¨è¿™ä¸ªå‘½ä»¤ CLI ä¼šæ¯”å¯¹å½“å‰æ•°æ®åº“ schema vs ç°æœ‰ migrationsï¼Œç”Ÿæˆä¸€ä¸ª migration è„šæœ¬ï¼ˆåå­—æ˜¯ `<timestamp>_<name>.sql`ï¼‰ ã€‚é€‚åˆä½ ä¸æƒ³æ‰‹å†™ SQLï¼Œä½†åˆæƒ³æŠŠæ”¹åŠ¨çº³å…¥ç‰ˆæœ¬æ§åˆ¶çš„æ—¶å€™ã€‚

------



Q1ï¼šé‚£æ€ä¹ˆä»è¿œç¨‹ä»“åº“æ‹‰æ–°çš„ db migrationå‘¢ï¼Ÿ

A1ï¼š

ä¸‹é¢æˆ‘è®² **å®é™…å¼€å‘ä¸­çœŸå®ä¼šé‡åˆ°çš„æƒ…å†µ**ï¼š

> â“ **â€œåˆ«äººæ”¹äº†æ•°æ®åº“ schema å¹¶æäº¤äº† migrationsï¼Œæˆ‘æ€ä¹ˆä»è¿œç¨‹ä»“åº“æ‹‰æ–°çš„ db migrationï¼Ÿâ€**

å…¶å®ç­”æ¡ˆéå¸¸ç®€å•ï¼š

### âœ… **Step 1ï¼šä½¿ç”¨ Git æ‹‰å–è¿œç¨‹ä»“åº“çš„æœ€æ–°ä»£ç ï¼ˆåŒ…å« migrationsï¼‰**

```bash
git pull origin main
```

æˆ–è€…ï¼š

```bash
git fetch
git pull
```

ä½ ä¼šè·å¾—æ›´æ–°åçš„ç›®å½•ï¼ŒåŒ…æ‹¬ï¼š

```
supabase/
  migrations/
    20251209145404_create_profiles_table.sql
    20251210130501_add_bio_to_profiles.sql
    ...
```

Supabase migration æ˜¯çº¯æ–‡æœ¬ SQL æ–‡ä»¶ï¼Œè¢« Git ç®¡æ§ï¼Œæ‰€ä»¥ä½ å°±æ˜¯ç”¨ Git æ‹‰ä¸‹æ¥ã€‚

---

### âœ… **Step 2ï¼šå°†æ‹‰ä¸‹æ¥çš„ migration åº”ç”¨åˆ°ä½ çš„æœ¬åœ°æ•°æ®åº“**

æœ¬åœ°æ•°æ®åº“ä¸ä¼šè‡ªåŠ¨æ›´æ–°ï¼Œéœ€è¦ä½ æ‰‹åŠ¨ applyã€‚

ä½ æœ‰ä¸¤ä¸ªé€‰æ‹©ï¼š

---

### ğŸ¥‡ æ–¹æ³• Aï¼ˆæ¨èï¼‰â€”â€”åªæ‰§è¡Œæ–°å¢çš„ migration

```bash
supabase migration up
```

Supabase CLI ä¼šï¼š

* æ£€æŸ¥æœ¬åœ°æ•°æ®åº“å·²ç»æ‰§è¡Œè¿‡å“ªäº› migration
* è‡ªåŠ¨æ‰§è¡Œ **æœªæ‰§è¡Œçš„æ–° migration æ–‡ä»¶**

è¿™æ˜¯æ­£å¸¸å¼€å‘æµç¨‹ã€‚

---

### ğŸ¥ˆ æ–¹æ³• B â€”â€”é‡ç½®æœ¬åœ°æ•°æ®åº“ + é‡å»ºæ‰€æœ‰ migrationï¼ˆé€‚åˆå¼€å‘ï¼‰

```bash
supabase db reset
```

å®ƒä¼šï¼š

* åˆ é™¤æœ¬åœ°æ•°æ®åº“
* é‡æ–°æ‰§è¡Œæ‰€æœ‰ migrationsï¼ˆæŒ‰æ—¶é—´é¡ºåºï¼‰
* è‡ªåŠ¨æ‰§è¡Œ seed.sqlï¼ˆå¦‚æœæœ‰ï¼‰

é€‚åˆï¼š

* ä½ æ•°æ®åº“è¢«ä½ ç©åäº†
* ä½ æƒ³æµ‹è¯•æ•´ä¸ªè¿ç§»é“¾æ˜¯å¦ä»ç„¶èƒ½æˆåŠŸæ‰§è¡Œ
* åˆæ¬¡åŠ å…¥å›¢é˜Ÿï¼Œéœ€è¦æŠŠæœ¬åœ°ç¯å¢ƒåŒæ­¥ä¸ºå¹²å‡€ç‰ˆæœ¬

---

### âš ï¸ é¡¹ç›®ä¸­è¿œç¨‹æ•°æ®åº“æ€ä¹ˆåŠï¼Ÿ

å¦‚æœè¿œç¨‹æ•°æ®åº“ä¹Ÿéœ€è¦åº”ç”¨æ–°å¢ migrationï¼š

åœ¨éƒ¨ç½²æ—¶ï¼ˆCI/CD æˆ–æ‰‹åŠ¨ï¼‰æ‰§è¡Œï¼š

```bash
supabase db push
```

å®ƒä¼šï¼š

* æ£€æŸ¥äº‘ç«¯ï¼ˆSupabase é¡¹ç›®ï¼‰å·²æ‰§è¡Œçš„ migration
* è‡ªåŠ¨æ‰§è¡Œäº‘ç«¯æœªæ‰§è¡Œçš„æ–° migration

å›¢é˜Ÿåä½œå°±æ˜¯é è¿™ä¸ªè‡ªåŠ¨ä¿æŒåŒæ­¥ã€‚

---

### ğŸ“Œ æ€»ç»“ï¼ˆè®°ä½è¿™ 3 è¡Œå°±å¤Ÿï¼‰

### âœ” **æ‹‰ migrations == git pull**

### âœ” **åŒæ­¥æœ¬åœ° DB == supabase migration up**

### âœ” **é‡å»ºæœ¬åœ°ç¯å¢ƒ == supabase db reset**

---



