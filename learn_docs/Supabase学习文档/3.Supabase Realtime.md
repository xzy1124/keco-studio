### 🚀 **Supabase Realtime 学习与使用指南**

Supabase Realtime 是一个基于 WebSocket 的实时系统，用来：

* 监听数据库变化（Insert / Update / Delete）
* 在客户端之间广播实时消息
* 同步在线状态 Presence（如“谁在线”）
* 构建多人协作、聊天室、在线白板、实时游戏、协同编辑等应用

它由 Postgres WAL 日志驱动，因此性能好、延迟低。

---

### ⭐ Realtime 三大核心模块

| 模块                 | 作用                                                | 典型场景                                      |
| -------------------- | --------------------------------------------------- | --------------------------------------------- |
| **Postgres Changes** | 监听数据库变更：INSERT / UPDATE / DELETE / TRUNCATE | 表数据实时同步、仪表板、聊天消息同步          |
| **Broadcast**        | 客户端广播 JSON 消息，不写入数据库                  | 协同编辑（光标、选区）、游戏状态、通知        |
| **Presence**         | 显示/同步在线用户状态（join/leave/update）          | 多人协作、聊天室在线用户列表、Cursor presence |

---

### 📌 一、Realtime 基础：频道（Channel）

Realtime 的一切行为都基于频道（房间）：

```ts
const channel = supabase.channel('room:123:messages', {
  config: { private: true }
})
```

推荐命名规范：

* `room:<id>:messages`
* `doc:<docId>:collab`
* `user:<id>:notifications`

生产环境建议 **private: true** 并启用 RLS。

---

### 📌 二、Postgres Changes（数据库变更监听）

用于监听 Postgres 的新增、更新、删除。

#### 支持事件：

| 事件         | 描述       |
| ------------ | ---------- |
| **INSERT**   | 表新增记录 |
| **UPDATE**   | 表更新记录 |
| **DELETE**   | 表删除记录 |
| **TRUNCATE** | 清空整张表 |

#### 使用方式：

```ts
const channel = supabase
  .channel('realtime:public:documents')
  .on('postgres_changes',
    { event: 'UPDATE', schema: 'public', table: 'documents' },
    (payload) => console.log('文档更新', payload)
  )
  .subscribe()
```

#### payload 内容：

```json
{
  "schema":"public",
  "table":"documents",
  "eventType":"UPDATE",
  "new": {...},
  "old": {...}
}
```

用于实时同步数据库数据，如：

* 管理后台实时更新
* 监控系统
* 简单协作编辑（但不适合高频变更）

---

### 📌 三、Broadcast（客户端实时广播）

不写入数据库，纯 WebSocket 消息，很适合 **协同编辑（光标、选区）**。

#### 发送消息：

```ts
channel.send({
  type: 'broadcast',
  event: 'cursor',
  payload: {
    userId,
    position
  }
})
```

#### 监听消息：

```ts
channel.on(
  'broadcast',
  { event: 'cursor' },
  (payload) => console.log('收到光标数据', payload)
)
```

典型场景：

* 文档协同编辑（光标同步）
* 游戏状态广播
* 直播评论流
* 低延迟消息推送

---

### 📌 四、Presence（在线用户存在状态）

Presence 用于跟踪：

* 谁在线
* 用户什么时候加入/离开
* 用户当前状态（cursor、name、color、selection）

Presence 会自动：

* 管理用户加入 / 离开事件
* 同步在线用户列表（initial sync）
* 保持状态（类似 Y.js awareness）

#### 设置 Presence：

```ts
channel.track({
  user_id: userId,
  username,
  cursor: { x: 100, y: 200 }
})
```

#### 监听 Presence 状态：

```ts
channel.on('presence', { event: 'sync' }, () => {
  const state = channel.presenceState()
  console.log('当前在线用户：', state)
})
```

适用场景：

* 在线用户列表
* Google Docs 风格的“谁在编辑”
* 光标/选区同步（推荐）

---

### 📌 五、在数据库中配置 RLS（私有频道必做）

私有频道需要允许 authenticated 用户进行 SELECT/INSERT：

```sql
-- 允许认证用户接收消息
CREATE POLICY "auth_receive" ON realtime.messages
FOR SELECT TO authenticated USING (true);

-- 允许认证用户发送消息
CREATE POLICY "auth_send" ON realtime.messages
FOR INSERT TO authenticated WITH CHECK (true);
```

---

### 📌 六、触发器：让 Postgres 自动向频道广播

适用于需要数据库触发事件推送的情况。

#### 方法 1：realtime.broadcast_changes（镜像变更）

```sql
PERFORM realtime.broadcast_changes(
  'room:' || NEW.room_id,
  TG_OP,
  TG_OP,
  TG_TABLE_NAME,
  TG_TABLE_SCHEMA,
  NEW,
  OLD
);
```

#### 方法 2：realtime.send（自定义内容）

```sql
PERFORM realtime.send(
  'room:' || NEW.room_id || ':notifications',
  'message_created',
  jsonb_build_object('id', NEW.id),
  true
);
```

---

### 📌 七、客户端清理订阅

避免内存泄漏：

```ts
useEffect(() => {
  const channel = supabase.channel('room:123:messages')

  return () => {
    supabase.removeChannel(channel)
  }
}, [])
```

---

### 🎯 八、最佳实践总结（最重要）

| 功能                   | 推荐方案                                 |
| ---------------------- | ---------------------------------------- |
| **文档内容同步**       | ❗不要用 Realtime → 使用 **Y.js（CRDT）** |
| **光标同步**           | **Supabase Presence**（一流体验）        |
| **选区同步**           | Presence 或 Broadcast                    |
| **事件通知**           | Broadcast                                |
| **在线用户列表**       | Presence                                 |
| **数据库数据变化监听** | Postgres Changes（小规模）               |

---

### 🎁 九、Tiptap 协同编辑推荐方案

#### 方案 A（最强 + 最稳定）：

| 功能           | 技术                            |
| -------------- | ------------------------------- |
| 文档内容持久化 | Y.js + Tiptap Collaboration Kit |
| 实时协作同步   | WebRTC 或 WebSocket Provider    |
| 光标/选区同步  | Supabase Realtime Presence      |
| 在线用户列表   | Presence                        |
| 定时保存       | 将 Y.Doc 序列化写入 Supabase    |

这是 Tiptap 官方推荐的常用组合。

---

### ✔ 总结

Supabase Realtime 提供的三大功能模块满足几乎所有实时场景：

---

#### **Postgres Changes**

监听数据库变更 → 适用于实时数据看板

#### **Broadcast**

给客户端之间发送实时消息 → 协同编辑、游戏、通知

#### **Presence**

管理用户在线状态 → 光标同步 / 在线用户列表

---

