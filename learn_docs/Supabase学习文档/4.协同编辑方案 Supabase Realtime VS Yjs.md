### 一、什么是 **Supabase Realtime？**

Supabase Realtime 是 Supabase 提供的 **实时系统**，基于 Postgres 的 WAL（Write-Ahead Log）日志构建。

它的作用类似于：

- WebSocket 服务器
- 用来订阅数据库的变化（insert、update、delete）
- 数据一更新，前端实时收到推送

使用方式：

```
const channel = supabase
  .channel('realtime:public:documents')
  .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'documents' }, (payload) => {
    console.log('文档更新', payload)
  })
  .subscribe()
```

------

### 🧠 它可以用来做什么？

#### ✔ 实时评论系统

有人提交评论 → 全体用户立即看到更新。

#### ✔ 实时通知

某条订单被更新 → 用户实时看到状态改变。

#### ✔ 实时列表刷新

如 “在线用户列表”、“订单状态列表”。

#### ✔ 简单的协同编辑（非常有限）

------

### ⚠️ 但注意：Realtime **不是** 为复杂协同编辑而设计的！

**Realtime 并不处理：**

- 冲突解决
- 游标位置
- 同步 selection ranges
- 操作变换（OT）
- CRDT 算法
- 多客户端同时打字的合并
- 快速连续变更（例如每 50ms 变一次）

Realtime 只能做到：

> “有人执行了 UPDATE，我告诉你这个 UPDATE 的结果”。

但富文本协同编辑需要更复杂的数据结构。

------

### ❌ 使用 Supabase Realtime 来做 Tiptap 协同编辑：不推荐

为什么？

1. **数据库写入频率太高**：每个 keystroke 都写数据库 → 数据库压力巨大
2. **没有冲突合并**：用户 A 和 B 同时敲字，会互相覆盖
3. **缺少 CRDT / OT 机制**：多用户协作会出错
4. **无法处理游标同步**

Supabase Realtime 更像 *事件通知*，不适合作为协同编辑协议。

------

### 🏆 二、那 Tiptap 官方推荐的协作方案是什么？

#### ✔ **方案 A：使用 Tiptap Collaboration Kit（基于 Y.js）** ← 最推荐

Tiptap 官方提供：

- CRDT（Y.js）
- 游标同步
- 冲突自动解决
- 离线编辑 / 自动合并
- 多人编辑光标显示
- 十分成熟

你需要：

- 前端：Next.js + Tiptap + @tiptap/extension-collaboration
- 后端：官方提供的 WebSocket 协作者 server（或你自己搭）

架构如下：

```
Next.js client <---- WebSocket ----> Yjs Websocket Server <----> Redis / Persistence
```

👉 参考：
https://tiptap.dev/docs/collaboration/getting-started/overview

------

### ✔ 为什么强烈推荐 Y.js？

因为它具有：

- CRDT 数据结构
- 无需锁机制
- 自动合并
- 解决冲突
- 多客户端之间同步
- 离线 Re-sync 支持
- 性能比你自己做要好 100 倍
- 文档行业的标配（类似 Google Docs）

------

### 💡 Supabase Realtime 适合 "辅助协作"，但不适合替代 CRDT

你可以用它做：

- "某个文档被打开了"
- "谁正在查看这个文档"
- "用户上线/下线通知"
- "协作用户列表"

但不能做：

❌ 富文本内容的同步
 ❌ 冲突自动合并

------

### 🏆 三、如果你必须把 Supabase 用在协作编辑里，那么最佳架构是：

#### ✔ **使用 Y.js + WebSocket 做协作同步（核心）**

#### ✔ **使用 Supabase 存储最终版本（持久化）**

#### ✔ **使用 Realtime 通知“文档被保存”事件（非协同编辑本身）**

流程：

1. 用户编辑 → 内容通过 Y.js WebSocket 同步给其他用户
2. 每隔 2 秒或点击保存 → 将 Y.js 文档序列化存入 Supabase
3. Supabase Realtime 触发 “文档已保存” 通知其他用户

这种方式结构清晰、性能佳、最接近 Google Docs。

------

### 🧩 四、总结

#### Supabase Realtime 是什么？

一个可以订阅数据库变更的 WebSocket 系统。

#### 可以用来做什么？

- 房间聊天
- 通知系统
- 实时刷新
- 在线用户状态
- 轻量协作事件（非内容同步）

#### 不推荐用来做什么？

❌ 富文本协同编辑（Tiptap）
 ❌ 实时词级同步
 ❌ 冲突合并

### 推荐的 Tiptap 协同方案？

🏆 **Y.js + Tiptap 官方协同扩展，这是行业标准。**

### 最佳架构？

- Y.js 负责协作内容同步
- Supabase 存储最终文档
- Supabase Realtime 做辅助在线状态



------

#### Q1：什么是CRDT 数据结构？

#### A1：什么是 CRDT？

**CRDT（Conflict-free Replicated Data Type）= 无冲突可复制数据类型**

一句话总结：

> **CRDT 是一种支持多端同时编辑、自动合并、无冲突的数据结构。即使多人离线修改，同步回来后也能自动合并。**

它是协同编辑（例如 Google Docs / Notion / 飞书文档 / Tiptap）的核心技术。

------

#### 🧠 为什么需要 CRDT？

假设两个人同时编辑一个文档：

- 用户 A 在第 3 行插入 “hello”
- 用户 B 在同一段落删除一些内容

传统数据库会发生冲突：

```
版本不一致
你修改的内容基于旧版本
```

但是 **CRDT 可以智能合并**：

```
最终内容 = B 的删除 + A 的插入，都保留
```

不用人工处理，也不会覆盖别人。

------

### 🎯 CRDT 的三大能力

#### ① 无中心（不需要一个主节点判断冲突）

每个客户端各自维护一份文档，称为「副本」。

#### ② 自动合并（不用锁，不用加版本号）

所有修改都会广播给其他人，当多个修改冲突时：

> CRDT 根据数学规则自动合并每个操作，不丢信息。

#### ③ 离线可编辑（回到网络自动同步）

用户 A 离线编辑，网络恢复后：

- A 的编辑合并到文档
- 不会覆盖他人内容
- 不需要手动决策

------

### 🔍 用一个例子理解 CRDT

假设文档初始是：

```
ABC
```

#### A 和 B 同时编辑：

用户 A：在 B 后面插入 “X”

```
ABXC
```

用户 B：删除 C

```
AB
```

如果没有 CRDT，会出错。

如果使用 CRDT：

- 会记录“插入 X 在 B 的后面”
- 会记录“删除字符 C”

这些操作可以根据 ID / 时序自动合并：

**最终结果可能是：**

```
ABX
```

所有操作都被正确处理。



------



#### Q2：  “如果你想做 Tiptap + Supabase 协同编辑，一般推荐组合： 用户光标/状态：Supabase Realtime Broadcast + Presence“    所以这种方式也可以很好进行协同编辑是吗？

#### A2：可以，但要分清 **协同编辑（内容同步）** 和 **协作体验（光标 / 在线状态）** 是两种不同的东西：

---

### ✅ **Supabase Realtime Broadcast + Presence 可以做什么？**

它非常适合：

#### ✔ 多人在线状态（谁在编辑？）

#### ✔ 多人光标同步（每个用户的光标位置）

#### ✔ 选区同步（高亮）

#### ✔ 打字提示（“xxx 正在输入…”）

#### ✔ 评论、提示、消息

#### ✔ 实时消息广播（但不可靠）

这些都不需要写入数据库，非常快。

---

### ❌ 但 Supabase Realtime **不适合做文档内容协同编辑**

#### 因为它是 WebSocket 的“广播”机制：

* **无冲突处理（不会自动 merge）**
* **无 CRDT**（没有 Y.js 那种自动合并编辑能力）
* **不保证消息顺序**
* **也不保证消息一定送达**
* **无法支持离线编辑 / 自动合并**

如果你仅靠 broadcast 来同步 Tiptap 文本内容，会导致：

* 用户 A 和 B 同时编辑 → 冲突 → 内容覆盖
* 离线用户重新上线 → 内容错乱
* 大文档同步时性能差
* 编辑历史不一致

这会导致文档错乱，非常不可靠。

---

### 🔥 **真正的协同编辑核心是 CRDT（比如 Y.js）**

协同编辑最难的是 “冲突自动处理”。
这方面 **Y.js 是业界最强的 CRDT**。

Y.js 帮你解决：

* A 和 B 同时改：自动 merge
* A 离线 10 分钟修改 → 上线自动同步
* 编辑顺序混乱也没关系（CRDT 自动解决）
* 编辑内容有历史版本
* 富文本结构自动合并

Supabase Realtime 做不到这些。

---

### 📌 **最佳方案：Tiptap Collaboration（Y.js） + Supabase Realtime**

| 功能         | 使用方案                                 |
| ------------ | ---------------------------------------- |
| 文档内容协同 | **Y.js（Tiptap Collaboration Kit）**     |
| 用户光标     | Supabase Realtime Broadcast/**Presence** |
| 用户在线列表 | Supabase Realtime Presence               |
| 持久化保存   | 定时把 Y.Doc 写入 Supabase               |

这是最稳定、最专业的行业标准方案（Tiptap 官方也是这么推荐的）。

---

### ⭐ 结论

#### ❗Supabase Realtime Broadcast + Presence

**不能** 完成完整的“协同编辑文档内容”，
但 **非常适合补充协同体验**（光标/UI 状态）。

#### ✔ 完整协同编辑

必须使用 **Y.js（CRDT）**，而不是 Realtime。

---

