name: Deploy to Vercel

on:
  push:
    branches:
      - main      
      - master
      - release
      - 'release/**'
  pull_request:
    branches:
      - main
      - master
      - release
      - 'release/**'
    types: [opened, synchronize, reopened]  

jobs:
 
  check-migrations:
    runs-on: ubuntu-latest
    name: Check for Migration Changes
    if: github.repository == 'xzy1124/keco-studio'
    outputs:
      has-migrations: ${{ steps.check.outputs.has-migrations }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  

      - name: Check for migration changes
        id: check
        run: |
          if git diff --name-only HEAD~1 HEAD | grep -q "^supabase/migrations/"; then
            echo "has-migrations=true" >> $GITHUB_OUTPUT
            echo "âœ… æ£€æµ‹åˆ°è¿ç§»æ–‡ä»¶å˜åŒ–"
          else
            echo "has-migrations=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ æ²¡æœ‰è¿ç§»æ–‡ä»¶å˜åŒ–ï¼Œè·³è¿‡è¿ç§»ä»»åŠ¡"
          fi

  
  migrate-database:
    runs-on: ubuntu-latest
    name: Run Supabase Migrations
    needs: check-migrations
    if: github.repository == 'xzy1124/keco-studio' && needs.check-migrations.outputs.has-migrations == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Supabase CLI
        run: npm install -g supabase@latest

      # æ ¹æ®åˆ†æ”¯é€‰æ‹© Supabase é¡¹ç›®å’Œå¯¹åº”çš„ Access Token
      # main åˆ†æ”¯ â†’ Production, release åˆ†æ”¯ â†’ Preview
      - name: Select Supabase Project and Token
        id: select-project
        env:
          PROD_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN_PROD }}
          PREVIEW_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN_PREVIEW }}
          GENERAL_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]] || [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
            # main åˆ†æ”¯ä½¿ç”¨ Production ç¯å¢ƒ
            echo "project-ref=${{ secrets.SUPABASE_PROJECT_REF_PROD }}" >> $GITHUB_OUTPUT
            echo "environment=production" >> $GITHUB_OUTPUT
            # å¦‚æœé…ç½®äº†å•ç‹¬çš„ Production Tokenï¼Œä½¿ç”¨å®ƒï¼›å¦åˆ™ä½¿ç”¨é€šç”¨çš„ Token
            if [ -n "$PROD_TOKEN" ] && [ "$PROD_TOKEN" != "" ]; then
              echo "access-token=$PROD_TOKEN" >> $GITHUB_OUTPUT
              echo "âœ… ä½¿ç”¨ Production Supabase é¡¹ç›® (å•ç‹¬ Token)"
            else
              echo "access-token=$GENERAL_TOKEN" >> $GITHUB_OUTPUT
              echo "âœ… ä½¿ç”¨ Production Supabase é¡¹ç›® (é€šç”¨ Token)"
            fi
          elif [[ "${{ github.ref }}" =~ ^refs/heads/release ]]; then
            # release åˆ†æ”¯ï¼ˆåŒ…æ‹¬ release/**ï¼‰ä½¿ç”¨ Preview ç¯å¢ƒ
            echo "project-ref=${{ secrets.SUPABASE_PROJECT_REF_PREVIEW }}" >> $GITHUB_OUTPUT
            echo "environment=preview" >> $GITHUB_OUTPUT
            # å¦‚æœé…ç½®äº†å•ç‹¬çš„ Preview Tokenï¼Œä½¿ç”¨å®ƒï¼›å¦åˆ™ä½¿ç”¨é€šç”¨çš„ Token
            if [ -n "$PREVIEW_TOKEN" ] && [ "$PREVIEW_TOKEN" != "" ]; then
              echo "access-token=$PREVIEW_TOKEN" >> $GITHUB_OUTPUT
              echo "âœ… ä½¿ç”¨ Preview Supabase é¡¹ç›® (release åˆ†æ”¯, å•ç‹¬ Token)"
            else
              echo "access-token=$GENERAL_TOKEN" >> $GITHUB_OUTPUT
              echo "âœ… ä½¿ç”¨ Preview Supabase é¡¹ç›® (release åˆ†æ”¯, é€šç”¨ Token)"
            fi
          else
            # å…¶ä»–æƒ…å†µï¼ˆPR ç­‰ï¼‰ä½¿ç”¨ Preview ç¯å¢ƒ
            echo "project-ref=${{ secrets.SUPABASE_PROJECT_REF_PREVIEW }}" >> $GITHUB_OUTPUT
            echo "environment=preview" >> $GITHUB_OUTPUT
            if [ -n "$PREVIEW_TOKEN" ] && [ "$PREVIEW_TOKEN" != "" ]; then
              echo "access-token=$PREVIEW_TOKEN" >> $GITHUB_OUTPUT
              echo "âœ… ä½¿ç”¨ Preview Supabase é¡¹ç›® (å•ç‹¬ Token)"
            else
              echo "access-token=$GENERAL_TOKEN" >> $GITHUB_OUTPUT
              echo "âœ… ä½¿ç”¨ Preview Supabase é¡¹ç›® (é€šç”¨ Token)"
            fi
          fi

      - name: Link to Supabase project
        run: |
          echo "ğŸ”— é“¾æ¥åˆ° Supabase é¡¹ç›®: ${{ steps.select-project.outputs.environment }}"
          echo "ğŸ“‹ Project Ref: ${{ steps.select-project.outputs.project-ref }}"
          supabase link --project-ref ${{ steps.select-project.outputs.project-ref }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ steps.select-project.outputs.access-token }}

      - name: Push database migrations
        run: |
          echo "ğŸš€ å¼€å§‹æ¨é€æ•°æ®åº“è¿ç§»åˆ° ${{ steps.select-project.outputs.environment }} ç¯å¢ƒ..."
          supabase db push
          echo "âœ… è¿ç§»å®Œæˆ"
        env:
          SUPABASE_ACCESS_TOKEN: ${{ steps.select-project.outputs.access-token }}
        continue-on-error: false  


  deploy:
    runs-on: ubuntu-latest
    needs: [check-migrations, migrate-database]  
    if: github.repository == 'xzy1124/keco-studio' && always() && (needs.migrate-database.result == 'success' || needs.migrate-database.result == 'skipped')
    name: Deploy to Vercel
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint
        continue-on-error: true  

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      # Determine deployment environment based on branch
      # main åˆ†æ”¯ â†’ Production, release åˆ†æ”¯ â†’ Preview
      - name: Determine deployment environment
        id: env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]] || [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "is_prod=true" >> $GITHUB_OUTPUT
            echo "deployment_target=production" >> $GITHUB_OUTPUT
            echo "âœ… éƒ¨ç½²åˆ° Production ç¯å¢ƒ (main åˆ†æ”¯)"
          elif [[ "${{ github.ref }}" =~ ^refs/heads/release ]]; then
            # release åˆ†æ”¯ï¼ˆåŒ…æ‹¬ release/**ï¼‰éƒ¨ç½²åˆ° Preview ç¯å¢ƒ
            echo "environment=preview" >> $GITHUB_OUTPUT
            echo "is_prod=false" >> $GITHUB_OUTPUT
            echo "deployment_target=preview" >> $GITHUB_OUTPUT
            echo "âœ… éƒ¨ç½²åˆ° Preview ç¯å¢ƒ (release åˆ†æ”¯)"
          else
            # PR ç­‰å…¶ä»–æƒ…å†µéƒ¨ç½²åˆ° Preview
            echo "environment=preview" >> $GITHUB_OUTPUT
            echo "is_prod=false" >> $GITHUB_OUTPUT
            echo "deployment_target=preview" >> $GITHUB_OUTPUT
            echo "âœ… éƒ¨ç½²åˆ° Preview ç¯å¢ƒ"
          fi

      # Pull Vercel environment variables based on deployment environment
      # This will automatically use the correct Supabase config (Production or Preview)
      # from Vercel Dashboard based on the environment determined above
      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=${{ steps.env.outputs.environment }} --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Build Project Artifacts
        run: |
          if [[ "${{ steps.env.outputs.is_prod }}" == "true" ]]; then
            vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
          else
            vercel build --token=${{ secrets.VERCEL_TOKEN }}
          fi
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Deploy Project Artifacts to Vercel
        run: |
          if [[ "${{ steps.env.outputs.is_prod }}" == "true" ]]; then
            # Production éƒ¨ç½²ï¼ˆmain åˆ†æ”¯ï¼‰
            echo "ğŸš€ éƒ¨ç½²åˆ° Production ç¯å¢ƒ..."
            vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}
          elif [[ "${{ steps.env.outputs.deployment_target }}" == "preview" ]] && [[ "${{ github.ref }}" =~ ^refs/tags/v ]]; then
            # Preview éƒ¨ç½²ï¼ˆTag æ¨é€ï¼‰- éƒ¨ç½²åˆ° Preview ç¯å¢ƒå¹¶ä½¿ç”¨å›ºå®šåŸŸå
            TAG_NAME=${GITHUB_REF#refs/tags/}
            echo "ğŸš€ éƒ¨ç½²åˆ° Preview ç¯å¢ƒ (Tag: $TAG_NAME)..."
            # éƒ¨ç½²åˆ° Preview ç¯å¢ƒï¼Œå¹¶ä½¿ç”¨å›ºå®šçš„ Preview åŸŸåä½œä¸º alias
            # æ³¨æ„ï¼škeco-release.vercel.app éœ€è¦åœ¨ Vercel Dashboard ä¸­é…ç½®ä¸ºé¡¹ç›®åŸŸå
            vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }} --env=${{ steps.env.outputs.environment }} --alias=keco-release.vercel.app
            echo "âœ… Preview éƒ¨ç½²å®Œæˆï¼ŒTag: $TAG_NAME"
            echo "ğŸŒ Preview URL: https://keco-release.vercel.app"
          else
            # Preview éƒ¨ç½²ï¼ˆrelease åˆ†æ”¯å’Œ PR ç­‰ï¼‰
            echo "ğŸš€ éƒ¨ç½²åˆ° Preview ç¯å¢ƒ..."
            vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }}
          fi
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          