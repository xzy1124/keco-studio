name: Deploy to Vercel

on:
  push:
    branches:
      - main      
      - master
      - 'release/**'
      - 'preview/**'   # 
    tags:
      - 'v*'  # æ”¯æŒ v1.0.0, v0.1.0 ç­‰æ ¼å¼çš„ tag
  pull_request:
    branches:
      - main
      - master
      - 'release/**'
      - 'preview/**'   # 
    types: [opened, synchronize, reopened]  

jobs:
 
  check-migrations:
    runs-on: ubuntu-latest
    name: Check for Migration Changes
    if: github.repository == 'xzy1124/keco-studio'
    outputs:
      has-migrations: ${{ steps.check.outputs.has-migrations }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  

      - name: Check for migration changes
        id: check
        run: |
          if git diff --name-only HEAD~1 HEAD | grep -q "^supabase/migrations/"; then
            echo "has-migrations=true" >> $GITHUB_OUTPUT
            echo "âœ… æ£€æµ‹åˆ°è¿ç§»æ–‡ä»¶å˜åŒ–"
          else
            echo "has-migrations=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ æ²¡æœ‰è¿ç§»æ–‡ä»¶å˜åŒ–ï¼Œè·³è¿‡è¿ç§»ä»»åŠ¡"
          fi

  
  migrate-database:
    runs-on: ubuntu-latest
    name: Run Supabase Migrations
    needs: check-migrations
    if: github.repository == 'xzy1124/keco-studio' && needs.check-migrations.outputs.has-migrations == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Supabase CLI
        run: npm install -g supabase@latest

      - name: Link to Supabase project
        run: |
          supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Push database migrations
        run: |
          echo "ðŸš€ å¼€å§‹æŽ¨é€æ•°æ®åº“è¿ç§»..."
          supabase db push
          echo "âœ… è¿ç§»å®Œæˆ"
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        continue-on-error: false  


  deploy:
    runs-on: ubuntu-latest
    needs: [check-migrations, migrate-database]  
    if: github.repository == 'xzy1124/keco-studio' && always() && (needs.migrate-database.result == 'success' || needs.migrate-database.result == 'skipped')
    name: Deploy to Vercel
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint
        continue-on-error: true  

      - name: Build project
        run: npm run build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      # Determine deployment environment based on branch
      - name: Determine deployment environment
        id: env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]] || [[ "${{ github.ref }}" == "refs/heads/master" ]] || [[ "${{ github.ref }}" =~ ^refs/tags/v ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "is_prod=true" >> $GITHUB_OUTPUT
            echo "âœ… éƒ¨ç½²åˆ° Production çŽ¯å¢ƒ"
          elif [[ "${{ github.ref }}" =~ ^refs/heads/release/ ]]; then
            echo "environment=preview" >> $GITHUB_OUTPUT
            echo "is_prod=false" >> $GITHUB_OUTPUT
            echo "âœ… éƒ¨ç½²åˆ° Preview çŽ¯å¢ƒ (Release åˆ†æ”¯)"
          else
            echo "environment=preview" >> $GITHUB_OUTPUT
            echo "is_prod=false" >> $GITHUB_OUTPUT
            echo "âœ… éƒ¨ç½²åˆ° Preview çŽ¯å¢ƒ"
          fi

      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=${{ steps.env.outputs.environment }} --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Build Project Artifacts
        run: |
          if [[ "${{ steps.env.outputs.is_prod }}" == "true" ]]; then
            vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
          else
            vercel build --token=${{ secrets.VERCEL_TOKEN }}
          fi
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Deploy Project Artifacts to Vercel
        run: |
          if [[ "${{ steps.env.outputs.is_prod }}" == "true" ]]; then
            vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}
          else
            vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }}
          fi
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
