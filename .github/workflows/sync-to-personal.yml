name: Sync to Personal Repository

# Trigger conditions: push to main/release/** or PR merge
on:
  push:
    branches:
      - main
      - release/**
  pull_request:
    branches:
      - main
      - release/**
    types: [closed]  # Only trigger on PR merge (closed)

jobs:
  sync-to-personal:
    runs-on: ubuntu-latest
    # Only run in team repository
    if: github.repository == 'Caerulean-ai/keco-studio' && (github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true))
    
    # Need write permission to push code
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history to ensure push won't fail
          # Use merge commit for PR merge, current commit for push
          ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.merge_commit_sha || github.sha }}
          # Don't specify token here - use default GITHUB_TOKEN to checkout team repository

      - name: Set up Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Determine target branch
        id: branch
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            # Push event: use current branch name
            echo "branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "‚úÖ Detected push event, target branch: ${{ github.ref_name }}"
          else
            # PR merge event: use base branch (branch being merged into)
            echo "branch=${{ github.event.pull_request.base.ref }}" >> $GITHUB_OUTPUT
            echo "‚úÖ Detected PR merge event, target branch: ${{ github.event.pull_request.base.ref }}"
          fi

      - name: Push to personal repo
        env:
          PERSONAL_GITHUB_TOKEN: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
        run: |
          # Remove existing remote if any
          git remote remove personal 2>/dev/null || true
          
          # Add personal repository remote
          git remote add personal https://x-access-token:${PERSONAL_GITHUB_TOKEN}@github.com/xzy1124/keco-studio.git
          
          # Get target branch name
          CURRENT_BRANCH="${{ steps.branch.outputs.branch }}"
          
          echo "üîÑ Preparing to sync branch: ${CURRENT_BRANCH} to personal repository xzy1124/keco-studio..."
          echo "üìç Current commit: $(git rev-parse HEAD)"
          echo "üìç Current commit message: $(git log -1 --pretty=%B)"
          
          # Get current HEAD commit SHA (ensure pushing correct commit)
          CURRENT_SHA=$(git rev-parse HEAD)
          
          # Ensure we're on the correct branch (for PR merge, might be in detached HEAD state)
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "üîÑ PR merge event, currently in detached HEAD state..."
            echo "üìç Using merge commit: ${CURRENT_SHA}"
            # Directly push current commit to target branch
            git push personal ${CURRENT_SHA}:refs/heads/${CURRENT_BRANCH} --force
          else
            # Push event, ensure we're on the correct branch
            echo "üîÑ Push event, ensuring we're on the correct branch..."
            git checkout ${CURRENT_BRANCH} 2>/dev/null || echo "‚ÑπÔ∏è Already on branch ${CURRENT_BRANCH}"
            
            echo "üìç Current branch: $(git branch --show-current)"
            echo "üìç Current commit: $(git rev-parse HEAD)"
            
            # Check if remote branch exists
            if git ls-remote --heads personal ${CURRENT_BRANCH} | grep -q "${CURRENT_BRANCH}"; then
              echo "‚úÖ Remote branch ${CURRENT_BRANCH} exists, performing force push..."
              # Branch exists, use force push to ensure sync with latest code
              git push personal ${CURRENT_BRANCH} --force
            else
              echo "‚úÖ Remote branch ${CURRENT_BRANCH} does not exist, creating and pushing..."
              # Branch doesn't exist, create new branch
              git push personal ${CURRENT_BRANCH}:${CURRENT_BRANCH}
            fi
          fi
          
          echo "‚úÖ Successfully synced to personal repository xzy1124/keco-studio (branch: ${CURRENT_BRANCH})"
          echo "üöÄ This will trigger the deploy-vercel.yml workflow in personal repository, automatically deploying to Vercel"
          
          # If it's main branch, also push tags (if any)
          if [ "${CURRENT_BRANCH}" == "main" ]; then
            echo "üîÑ Syncing tags to personal repository..."
            git push personal --tags || echo "‚ÑπÔ∏è No tags to sync"
          fi

